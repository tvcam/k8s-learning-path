---
- name: Provision Hetzner servers
  hosts: localhost
  connection: local
  gather_facts: false
  become: no
  vars:
    hcloud_token: "{{ lookup('env', 'HCLOUD_TOKEN') }}"
    location: hel1
    image: ubuntu-22.04
    ssh_key_name: vibol_z400        # must exist in your Hetzner Cloud account
    server_type_master: cx32       # 4 CPU, 8GB RAM
    server_type_worker: cx22       # 2 CPU, 4GB RAM
    master_count: 1
    worker_count: 1                # Using 1 worker due to server limits on new accounts

  tasks:
    - name: Create master node
      hetzner.hcloud.hcloud_server:
        api_token: "{{ hcloud_token }}"
        name: "k8s-master"
        server_type: "{{ server_type_master }}"
        image: "{{ image }}"
        location: "{{ location }}"
        ssh_keys:
          - "{{ ssh_key_name }}"
        state: present
      register: master

    - name: Create worker nodes
      hetzner.hcloud.hcloud_server:
        api_token: "{{ hcloud_token }}"
        name: "k8s-worker-{{ item }}"
        server_type: "{{ server_type_worker }}"
        image: "{{ image }}"
        location: "{{ location }}"
        ssh_keys:
          - "{{ ssh_key_name }}"
        state: present
      loop: "{{ range(1, worker_count + 1) | list }}"
      register: workers

    - name: Wait for servers to be fully ready
      pause:
        seconds: 5

    - name: Get master server info
      hetzner.hcloud.hcloud_server_info:
        api_token: "{{ hcloud_token }}"
        name: "k8s-master"
      register: master_info

    - name: Get worker server info
      hetzner.hcloud.hcloud_server_info:
        api_token: "{{ hcloud_token }}"
        name: "k8s-worker-{{ item }}"
      loop: "{{ range(1, worker_count + 1) | list }}"
      register: workers_info

    - name: Generate inventory file
      copy:
        dest: inventory.ini
        content: |
          [master]
          master ansible_host={{ master_info.hcloud_server_info[0].ipv4_address }} ansible_user=root

          [workers]
          {% for w in workers_info.results %}
          worker{{ loop.index }} ansible_host={{ w.hcloud_server_info[0].ipv4_address }} ansible_user=root
          {% endfor %}

          [kubernetes:children]
          master
          workers

    - name: Show connection info
      debug:
        msg: |
          Cluster created âœ…
          Master IP: {{ master_info.hcloud_server_info[0].ipv4_address }}
          Worker IPs:
          {% for w in workers_info.results %}
            - {{ w.hcloud_server_info[0].ipv4_address }}
          {% endfor %}
          Inventory saved to ./inventory.ini

