# Kubernetes Cluster Setup with Ansible

This Ansible setup automates the creation and configuration of a Kubernetes cluster on Hetzner Cloud.

## Prerequisites

1. **Python 3.9+** (Python 3.11 recommended)
   - The Hetzner Cloud collection requires Python 3.9 or newer
   - Check your version: `python3.11 --version` or `python3 --version`
   - If needed, install: `sudo apt install python3.11`

2. **Hetzner Cloud API Token**
   - Create from [console.hetzner.cloud → Access → API Tokens]
   - Must start with `hcloud_...`

3. **SSH Key in Hetzner Cloud**
   - Add your SSH key to Hetzner Cloud console
   - Update `ssh_key_name` in `provision.yml` to match your key name

4. **Install Dependencies**

```bash
# Install pip for Python 3.11 (if not already installed)
curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11 - --user

# Install Ansible with Python 3.11
python3.11 -m pip install --user ansible

# Add Ansible to PATH (add this to your ~/.zshrc or ~/.bashrc to make it permanent)
export PATH="$HOME/.local/bin:$PATH"

# Install Hetzner Cloud collection and Python library
ansible-galaxy collection install hetzner.hcloud
python3.11 -m pip install --user hcloud

# Optional: Install hetzner CLI for manual server management
curl -sSLO https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz
sudo tar -C /usr/local/bin --no-same-owner -xzf hcloud-linux-amd64.tar.gz hcloud
rm hcloud-linux-amd64.tar.gz
```

**Important:** Make sure `~/.local/bin` is in your PATH. Add this to your `~/.zshrc`:
```bash
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc
```

5. **Export API Token**

```bash
export HCLOUD_TOKEN="hcloud_xxxxxxxxxxxxxxxxxxxxx"
```

## Usage

### 1. Provision Servers

This creates the master and worker nodes on Hetzner Cloud:

```bash
cd ansible
ansible-playbook provision.yml
```

This will:
- Create 1 master node (cx32: 4 CPU, 8GB RAM)
- Create 2 worker nodes (cx22: 2 CPU, 4GB RAM)
- Generate `inventory.ini` with server IPs

### 2. Configure Kubernetes Cluster

This installs and configures Kubernetes on all nodes:

```bash
ansible-playbook -i inventory.ini playbook.yml
```

This will:
- Install containerd on all nodes
- Set up system requirements (disable swap, load kernel modules, etc.)
- Initialize Kubernetes control plane on master
- Install Flannel CNI
- Join worker nodes to the cluster

**Time:** ~10-15 minutes

### 3. Access the Cluster

SSH into the master node:

```bash
ssh root@$(grep master inventory.ini | awk '{print $2}' | cut -d= -f2)
```

Check the cluster status:

```bash
kubectl get nodes
```

### 4. Destroy the Cluster (Optional)

When done, remove all servers:

```bash
ansible-playbook destroy.yml
```

## Configuration

### Customizing Server Types

Edit `provision.yml` to change:
- `server_type_master`: Master node size (default: cx32)
- `server_type_worker`: Worker node size (default: cx22)
- `worker_count`: Number of worker nodes (default: 2)
- `location`: Hetzner datacenter (default: hel1)

### Customizing Kubernetes Version

Edit the repository URL in:
- `roles/kubernetes-master/tasks/main.yml`
- `roles/kubernetes-worker/tasks/main.yml`

Change `v1.30` to your desired version.

## Troubleshooting

### SSH Connection Issues

If you get SSH connection errors, wait a few minutes for servers to fully boot, then retry.

### Join Command Issues

If workers fail to join, regenerate the join command on master:

```bash
ssh root@<master-ip>
kubeadm token create --print-join-command
```

Then manually run the command on workers.

## Structure

```
ansible/
├── inventory.ini             # Auto-generated by provision.yml
├── playbook.yml              # Main cluster setup playbook
├── provision.yml             # Server provisioning playbook
├── destroy.yml               # Cleanup playbook
├── README.md                 # This file
└── roles/
    ├── common/               # System setup (swap, kernel modules, etc.)
    ├── containerd/           # Container runtime
    ├── kubernetes-master/    # Control plane setup
    └── kubernetes-worker/    # Worker node setup
```

